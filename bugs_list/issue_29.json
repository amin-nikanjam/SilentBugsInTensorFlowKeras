{
  "url": "https://api.github.com/repos/tensorflow/tensorflow/issues/45162",
  "repository_url": "https://api.github.com/repos/tensorflow/tensorflow",
  "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/45162/labels{/name}",
  "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/45162/comments",
  "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/45162/events",
  "html_url": "https://github.com/tensorflow/tensorflow/issues/45162",
  "id": 750175812,
  "node_id": "MDU6SXNzdWU3NTAxNzU4MTI=",
  "number": 45162,
  "title": "Training a tf.keras.Model, with a tf.data.Dataset mapped with a randomly selected action from a large list of actions (callables provided by the user) takes a lot of time to start, if it ever does.",
  "user": {
    "login": "juanma9613",
    "id": 39193747,
    "node_id": "MDQ6VXNlcjM5MTkzNzQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/39193747?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/juanma9613",
    "html_url": "https://github.com/juanma9613",
    "followers_url": "https://api.github.com/users/juanma9613/followers",
    "following_url": "https://api.github.com/users/juanma9613/following{/other_user}",
    "gists_url": "https://api.github.com/users/juanma9613/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/juanma9613/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/juanma9613/subscriptions",
    "organizations_url": "https://api.github.com/users/juanma9613/orgs",
    "repos_url": "https://api.github.com/users/juanma9613/repos",
    "events_url": "https://api.github.com/users/juanma9613/events{/privacy}",
    "received_events_url": "https://api.github.com/users/juanma9613/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 386191887,
      "node_id": "MDU6TGFiZWwzODYxOTE4ODc=",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response",
      "name": "stat:awaiting response",
      "color": "f4b400",
      "default": false,
      "description": "Status  - Awaiting response from author"
    },
    {
      "id": 473172988,
      "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug",
      "name": "type:bug",
      "color": "159b2e",
      "default": false,
      "description": "Bug"
    },
    {
      "id": 474725938,
      "node_id": "MDU6TGFiZWw0NzQ3MjU5Mzg=",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stalled",
      "name": "stalled",
      "color": "d4c5f9",
      "default": false,
      "description": "stalled"
    },
    {
      "id": 1097546578,
      "node_id": "MDU6TGFiZWwxMDk3NTQ2NTc4",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:keras",
      "name": "comp:keras",
      "color": "0052cc",
      "default": false,
      "description": "Keras related issues"
    },
    {
      "id": 1946362326,
      "node_id": "MDU6TGFiZWwxOTQ2MzYyMzI2",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/TF%202.3",
      "name": "TF 2.3",
      "color": "1d76db",
      "default": false,
      "description": "Issues related to TF 2.3"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "Saduf2019",
    "id": 59822926,
    "node_id": "MDQ6VXNlcjU5ODIyOTI2",
    "avatar_url": "https://avatars.githubusercontent.com/u/59822926?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/Saduf2019",
    "html_url": "https://github.com/Saduf2019",
    "followers_url": "https://api.github.com/users/Saduf2019/followers",
    "following_url": "https://api.github.com/users/Saduf2019/following{/other_user}",
    "gists_url": "https://api.github.com/users/Saduf2019/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/Saduf2019/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/Saduf2019/subscriptions",
    "organizations_url": "https://api.github.com/users/Saduf2019/orgs",
    "repos_url": "https://api.github.com/users/Saduf2019/repos",
    "events_url": "https://api.github.com/users/Saduf2019/events{/privacy}",
    "received_events_url": "https://api.github.com/users/Saduf2019/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "Saduf2019",
      "id": 59822926,
      "node_id": "MDQ6VXNlcjU5ODIyOTI2",
      "avatar_url": "https://avatars.githubusercontent.com/u/59822926?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/Saduf2019",
      "html_url": "https://github.com/Saduf2019",
      "followers_url": "https://api.github.com/users/Saduf2019/followers",
      "following_url": "https://api.github.com/users/Saduf2019/following{/other_user}",
      "gists_url": "https://api.github.com/users/Saduf2019/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/Saduf2019/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/Saduf2019/subscriptions",
      "organizations_url": "https://api.github.com/users/Saduf2019/orgs",
      "repos_url": "https://api.github.com/users/Saduf2019/repos",
      "events_url": "https://api.github.com/users/Saduf2019/events{/privacy}",
      "received_events_url": "https://api.github.com/users/Saduf2019/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 8,
  "created_at": "2020-11-25T00:15:50Z",
  "updated_at": "2020-12-14T11:27:59Z",
  "closed_at": "2020-12-14T11:27:58Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow):\r\n\r\nYes, I have, there's a colab notebook below with the custom code.\r\n\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04):\r\n\r\ncolab notebook\r\n- TensorFlow installed from (source or binary):\r\n\r\ncolab default version 2.3.0\r\n\r\n- TensorFlow version (use command below):\r\n\r\n2.3.0\r\n\r\n- Python version:\r\n\r\n3.6.9\r\n\r\n- GPU model and memory:\r\n\r\nIt happens using any of the GPUs available in Colab : Nvidia K80s, T4s, P4s and P100s, or even when I'm not using GPU\r\n\r\n**Describe the current behavior**\r\n\r\nTraining a tf.keras.Model, with a tf.data.Dataset mapped with a custom augmentator, which randomly selects an action from a large list of actions (callables provided during the instantiation of the augmentator) takes a lot of time to start, if it ever does.\r\n\r\nIf it ever manages to start training (more than 20 minutes), then it takes even more time to start the epoch 3, epoch 5, epoch 7, etc.\r\n\r\n\r\n\r\n**Describe the expected behavior**\r\n\r\nTraining should start fast as usual, and shouldn't have overhead to start in some epochs.\r\n\r\n**Standalone code to reproduce the issue**\r\nI have created a colab with about 40 lines of code in which the code can be reproduced: \r\n\r\nhttps://colab.research.google.com/drive/1FyNuTlX6puKIosWPNojcEN9zZi9-60Ve?usp=sharing\r\n\r\n**Other info**\r\n\r\n\r\nA little bit more information about the colab contents and the issue here: \r\n\r\n\r\n- Context a RandomAugmentationPolicy object can be instantiated with a list of callables, and is used to map a dataset with tf.data.Dataset.map. For each img in the dataset, it randomly samples one of its actions, and augments the img.\r\n\r\n- Problem : When the length of the list of actions provided to instantiate a RandomAugmentationPolicy object is about 24 or more, training a tf.keras.Model using model.fit never starts the epoch 3 when running on colab.  When running on an ubuntu machine (aws p3.2xlarge) with a CPU that has 8 cores it never starts epoch 7.\r\n\r\n- Sample code to reproduce the issue : The code in the colab first defines the RandomAugmentationPolicy class previously mentioned, then it created a mocked dataset, and it then tries to train a model tf.keras.Model.fit.\r\n\r\n- Note : The only reasonable way I found to apply the 'selected_action' (L22 class definition), is to iterate over all the actions and augment the img when the action idx is equal to the desired action.\r\n\r\n\r\n\r\nThank you in advance for your help with this issue.\r\n\r\n\r\n\r\n",
  "closed_by": {
    "login": "google-ml-butler[bot]",
    "id": 56610014,
    "node_id": "MDM6Qm90NTY2MTAwMTQ=",
    "avatar_url": "https://avatars.githubusercontent.com/in/43729?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/google-ml-butler%5Bbot%5D",
    "html_url": "https://github.com/apps/google-ml-butler",
    "followers_url": "https://api.github.com/users/google-ml-butler%5Bbot%5D/followers",
    "following_url": "https://api.github.com/users/google-ml-butler%5Bbot%5D/following{/other_user}",
    "gists_url": "https://api.github.com/users/google-ml-butler%5Bbot%5D/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/google-ml-butler%5Bbot%5D/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/google-ml-butler%5Bbot%5D/subscriptions",
    "organizations_url": "https://api.github.com/users/google-ml-butler%5Bbot%5D/orgs",
    "repos_url": "https://api.github.com/users/google-ml-butler%5Bbot%5D/repos",
    "events_url": "https://api.github.com/users/google-ml-butler%5Bbot%5D/events{/privacy}",
    "received_events_url": "https://api.github.com/users/google-ml-butler%5Bbot%5D/received_events",
    "type": "Bot",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/tensorflow/tensorflow/issues/45162/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/45162/timeline",
  "performed_via_github_app": null
}

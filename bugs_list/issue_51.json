{
  "url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30423",
  "repository_url": "https://api.github.com/repos/tensorflow/tensorflow",
  "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30423/labels{/name}",
  "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30423/comments",
  "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30423/events",
  "html_url": "https://github.com/tensorflow/tensorflow/issues/30423",
  "id": 464460271,
  "node_id": "MDU6SXNzdWU0NjQ0NjAyNzE=",
  "number": 30423,
  "title": "2.0 beta's \"zero_output_for_mask\" produces unexpected zero-filling behaviors for GRU, LSTM.",
  "user": {
    "login": "jangmino",
    "id": 1531875,
    "node_id": "MDQ6VXNlcjE1MzE4NzU=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1531875?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jangmino",
    "html_url": "https://github.com/jangmino",
    "followers_url": "https://api.github.com/users/jangmino/followers",
    "following_url": "https://api.github.com/users/jangmino/following{/other_user}",
    "gists_url": "https://api.github.com/users/jangmino/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jangmino/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jangmino/subscriptions",
    "organizations_url": "https://api.github.com/users/jangmino/orgs",
    "repos_url": "https://api.github.com/users/jangmino/repos",
    "events_url": "https://api.github.com/users/jangmino/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jangmino/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 386191887,
      "node_id": "MDU6TGFiZWwzODYxOTE4ODc=",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20response",
      "name": "stat:awaiting response",
      "color": "f4b400",
      "default": false,
      "description": "Status  - Awaiting response from author"
    },
    {
      "id": 473172988,
      "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug",
      "name": "type:bug",
      "color": "159b2e",
      "default": false,
      "description": "Bug"
    },
    {
      "id": 1097546578,
      "node_id": "MDU6TGFiZWwxMDk3NTQ2NTc4",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:keras",
      "name": "comp:keras",
      "color": "0052cc",
      "default": false,
      "description": "Keras related issues"
    },
    {
      "id": 1160540362,
      "node_id": "MDU6TGFiZWwxMTYwNTQwMzYy",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/TF%202.0",
      "name": "TF 2.0",
      "color": "e79b38",
      "default": false,
      "description": "Issues relating to TensorFlow 2.0"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "qlzh727",
    "id": 5118881,
    "node_id": "MDQ6VXNlcjUxMTg4ODE=",
    "avatar_url": "https://avatars.githubusercontent.com/u/5118881?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/qlzh727",
    "html_url": "https://github.com/qlzh727",
    "followers_url": "https://api.github.com/users/qlzh727/followers",
    "following_url": "https://api.github.com/users/qlzh727/following{/other_user}",
    "gists_url": "https://api.github.com/users/qlzh727/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/qlzh727/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/qlzh727/subscriptions",
    "organizations_url": "https://api.github.com/users/qlzh727/orgs",
    "repos_url": "https://api.github.com/users/qlzh727/repos",
    "events_url": "https://api.github.com/users/qlzh727/events{/privacy}",
    "received_events_url": "https://api.github.com/users/qlzh727/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "qlzh727",
      "id": 5118881,
      "node_id": "MDQ6VXNlcjUxMTg4ODE=",
      "avatar_url": "https://avatars.githubusercontent.com/u/5118881?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/qlzh727",
      "html_url": "https://github.com/qlzh727",
      "followers_url": "https://api.github.com/users/qlzh727/followers",
      "following_url": "https://api.github.com/users/qlzh727/following{/other_user}",
      "gists_url": "https://api.github.com/users/qlzh727/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/qlzh727/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/qlzh727/subscriptions",
      "organizations_url": "https://api.github.com/users/qlzh727/orgs",
      "repos_url": "https://api.github.com/users/qlzh727/repos",
      "events_url": "https://api.github.com/users/qlzh727/events{/privacy}",
      "received_events_url": "https://api.github.com/users/qlzh727/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2019-07-05T04:50:32Z",
  "updated_at": "2020-04-29T23:16:17Z",
  "closed_at": "2019-09-13T16:41:49Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<em>Please make sure that this is a bug. As per our [GitHub Policy](https://github.com/tensorflow/tensorflow/blob/master/ISSUES.md), we only address code/doc bugs, performance issues, feature requests and build/installation issues on GitHub. tag:bug_template</em>\r\n\r\n**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow): yes\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Ubuntu 18.04.2 LTS in GOOGLE COLAB\r\n- Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device: None\r\n- TensorFlow installed from (source or binary): binary\r\n- TensorFlow version (use command below): v2.0.0-beta0-16-g1d91213fe7 2.0.0-beta1\r\n- Python version: Python 3.6.8\r\n- Bazel version (if compiling from source):\r\n- GCC/Compiler version (if compiling from source):\r\n- CUDA/cuDNN version: CUDA Version: 10.0\r\n- GPU model and memory: Tesla T4 (16G)\r\n\r\nYou can collect some of this information using our environment capture\r\n[script](https://github.com/tensorflow/tensorflow/tree/master/tools/tf_env_collect.sh)\r\nYou can also obtain the TensorFlow version with: 1. TF 1.0: `python -c \"import\r\ntensorflow as tf; print(tf.GIT_VERSION, tf.VERSION)\"` 2. TF 2.0: `python -c\r\n\"import tensorflow as tf; print(tf.version.GIT_VERSION, tf.version.VERSION)\"`\r\n\r\n**Describe the current behavior**\r\nThe call() methods of tf.keras.layers.GRU and others (e.g. LSTM) does not produce output as expected for \"zero_output_for_mask\"  when the layer is created with \"return_sequences=True\".\r\nRegardless of the value \"zero_output_for_mask\", the result of call() fills zeros for masked timestamps.\r\n\r\n**Describe the expected behavior**\r\nIt should produce outputs as the masked timestamps should be filled zeros if zero_output_for_mask is True. If false,  the masked timestamps should be filled with previous outputs. \r\n\r\n**Code to reproduce the issue**\r\nProvide a reproducible test case that is the bare minimum necessary to generate the problem.\r\n\r\n```\r\nimport tensorflow as tf\r\nimport numpy as np\r\n\r\nfor zero_output_for_mask in [False, True]:\r\n  #tf.keras.Sequential Model\r\n  model = tf.keras.Sequential([\r\n      tf.keras.layers.Embedding(16, 5, mask_zero=True),\r\n      tf.keras.layers.GRU(5, return_sequences=True, zero_output_for_mask=zero_output_for_mask)\r\n  ]\r\n  )\r\n\r\n  model.compile(\r\n      optimizer='rmsprop',\r\n      loss='mse'\r\n      )\r\n\r\n  np_x = np.ones((2, 5), dtype=np.float32)\r\n\r\n  # masking timestamp 3,4 of sample index 1.\r\n  np_x[1, 3:] = 0\r\n  #print(np_x)\r\n\r\n  # model's call()\r\n  result_mask_call = model(np_x)\r\n\r\n  print(\"---- zero_output_for_mask is {} ------\".format(zero_output_for_mask))\r\n  print(result_mask_call[1,:].numpy())\r\n\r\n```\r\n\r\n**Other info / logs**\r\nInclude any logs or source code that would be helpful to diagnose the problem. If including tracebacks, please include the full traceback. Large logs and files should be attached.\r\n\r\nI suspect that tf2.0 alpha's GRU's call() is changed in tf2.0 beta version.\r\nPLEASE refer FINAL line of both snippets.\r\n\r\nbeta version snippet of GRU's call() in recurrent_v2.py \r\n```\r\n  def call(self, inputs, mask=None, training=None, initial_state=None):\r\n    # GRU does not support constants. Ignore it during process.\r\n    inputs, initial_state, _ = self._process_inputs(inputs, initial_state, None)\r\n\r\n    if isinstance(mask, list):\r\n      mask = mask[0]\r\n\r\n    input_shape = K.int_shape(inputs)\r\n    timesteps = input_shape[0] if self.time_major else input_shape[1]\r\n\r\n    if not self.could_use_cudnn:\r\n```\r\n\r\nalpha version snippet of GRU's call() in recurrent.py (UnifiedGRU)\r\n```\r\n  def call(self, inputs, mask=None, training=None, initial_state=None):\r\n    # GRU does not support constants. Ignore it during process.\r\n    inputs, initial_state, _ = self._process_inputs(inputs, initial_state, None)\r\n\r\n    if isinstance(mask, list):\r\n      mask = mask[0]\r\n\r\n    input_shape = K.int_shape(inputs)\r\n    timesteps = input_shape[0] if self.time_major else input_shape[1]\r\n\r\n    if mask is not None or not self.could_use_cudnn:\r\n```\r\n",
  "closed_by": {
    "login": "jvishnuvardhan",
    "id": 46058173,
    "node_id": "MDQ6VXNlcjQ2MDU4MTcz",
    "avatar_url": "https://avatars.githubusercontent.com/u/46058173?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jvishnuvardhan",
    "html_url": "https://github.com/jvishnuvardhan",
    "followers_url": "https://api.github.com/users/jvishnuvardhan/followers",
    "following_url": "https://api.github.com/users/jvishnuvardhan/following{/other_user}",
    "gists_url": "https://api.github.com/users/jvishnuvardhan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jvishnuvardhan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jvishnuvardhan/subscriptions",
    "organizations_url": "https://api.github.com/users/jvishnuvardhan/orgs",
    "repos_url": "https://api.github.com/users/jvishnuvardhan/repos",
    "events_url": "https://api.github.com/users/jvishnuvardhan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jvishnuvardhan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30423/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30423/timeline",
  "performed_via_github_app": null
}

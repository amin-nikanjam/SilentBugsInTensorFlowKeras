{
  "url": "https://api.github.com/repos/tensorflow/tensorflow/issues/29558",
  "repository_url": "https://api.github.com/repos/tensorflow/tensorflow",
  "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/29558/labels{/name}",
  "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/29558/comments",
  "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/29558/events",
  "html_url": "https://github.com/tensorflow/tensorflow/issues/29558",
  "id": 453808332,
  "node_id": "MDU6SXNzdWU0NTM4MDgzMzI=",
  "number": 29558,
  "title": "model.fit() does not reshuffle the dataset between epochs",
  "user": {
    "login": "ageron",
    "id": 76661,
    "node_id": "MDQ6VXNlcjc2NjYx",
    "avatar_url": "https://avatars.githubusercontent.com/u/76661?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ageron",
    "html_url": "https://github.com/ageron",
    "followers_url": "https://api.github.com/users/ageron/followers",
    "following_url": "https://api.github.com/users/ageron/following{/other_user}",
    "gists_url": "https://api.github.com/users/ageron/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ageron/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ageron/subscriptions",
    "organizations_url": "https://api.github.com/users/ageron/orgs",
    "repos_url": "https://api.github.com/users/ageron/repos",
    "events_url": "https://api.github.com/users/ageron/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ageron/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 473172988,
      "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug",
      "name": "type:bug",
      "color": "159b2e",
      "default": false,
      "description": "Bug"
    },
    {
      "id": 1097546578,
      "node_id": "MDU6TGFiZWwxMDk3NTQ2NTc4",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:keras",
      "name": "comp:keras",
      "color": "0052cc",
      "default": false,
      "description": "Keras related issues"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "jsimsa",
    "id": 1072079,
    "node_id": "MDQ6VXNlcjEwNzIwNzk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072079?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jsimsa",
    "html_url": "https://github.com/jsimsa",
    "followers_url": "https://api.github.com/users/jsimsa/followers",
    "following_url": "https://api.github.com/users/jsimsa/following{/other_user}",
    "gists_url": "https://api.github.com/users/jsimsa/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jsimsa/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jsimsa/subscriptions",
    "organizations_url": "https://api.github.com/users/jsimsa/orgs",
    "repos_url": "https://api.github.com/users/jsimsa/repos",
    "events_url": "https://api.github.com/users/jsimsa/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jsimsa/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "jsimsa",
      "id": 1072079,
      "node_id": "MDQ6VXNlcjEwNzIwNzk=",
      "avatar_url": "https://avatars.githubusercontent.com/u/1072079?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/jsimsa",
      "html_url": "https://github.com/jsimsa",
      "followers_url": "https://api.github.com/users/jsimsa/followers",
      "following_url": "https://api.github.com/users/jsimsa/following{/other_user}",
      "gists_url": "https://api.github.com/users/jsimsa/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/jsimsa/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/jsimsa/subscriptions",
      "organizations_url": "https://api.github.com/users/jsimsa/orgs",
      "repos_url": "https://api.github.com/users/jsimsa/repos",
      "events_url": "https://api.github.com/users/jsimsa/events{/privacy}",
      "received_events_url": "https://api.github.com/users/jsimsa/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 5,
  "created_at": "2019-06-08T16:00:56Z",
  "updated_at": "2020-02-28T00:44:10Z",
  "closed_at": "2020-02-28T00:44:07Z",
  "author_association": "CONTRIBUTOR",
  "active_lock_reason": null,
  "body": "**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow):\r\nYes\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04):\r\nMacOSX 10.13.6\r\n- Mobile device (e.g. iPhone 8, Pixel 2, Samsung Galaxy) if the issue happens on mobile device:\r\nN/A\r\n- TensorFlow installed from (source or binary):\r\nbinary\r\n- TensorFlow version (use command below):\r\nVERSION='2.0.0-dev20190606'\r\nGIT_VERSION='v1.12.1-3447-g5a0f1bbfb7'\r\n- Python version:\r\n3.6.8\r\n- Bazel version (if compiling from source):\r\nN/A\r\n- GCC/Compiler version (if compiling from source):\r\nN/A\r\n- CUDA/cuDNN version:\r\nN/A\r\n- GPU model and memory:\r\nN/A\r\n\r\n**Describe the current behavior**\r\nWhen calling `model.fit(dataset, epochs=2)` with a finite shuffled dataset, the model is trained on the same dataset order at each epoch.\r\n\r\n**Describe the expected behavior**\r\nI expect the dataset to be reshuffled after each epoch. Right now, it's not, even when I use `reshuffle_each_iteration=True` in the dataset's `shuffle()` method. This argument seems to only shuffle between iterations within one epoch.\r\n\r\n**Code to reproduce the issue**\r\n\r\n```python\r\nimport tensorflow as tf\r\nfrom tensorflow import keras\r\nimport numpy as np\r\n\r\nX = np.arange(6).astype(np.float32).reshape(-1, 1)\r\ny = X**2\r\ndataset = tf.data.Dataset.from_tensor_slices((X,y))\r\ndataset = dataset.shuffle(100, reshuffle_each_iteration=True)\r\ndataset = dataset.repeat(2)\r\ndataset = dataset.batch(2)\r\n\r\n@tf.function\r\ndef log_inputs(inputs):\r\n    tf.print(inputs)\r\n    return inputs\r\n\r\nmodel = keras.models.Sequential([\r\n    keras.layers.Lambda(log_inputs),\r\n    keras.layers.Dense(1)\r\n])\r\nmodel.compile(loss=\"mse\", optimizer=\"sgd\")\r\nmodel.fit(dataset, epochs=2, verbose=0)\r\n```\r\n\r\n**Other info / logs**\r\nThe output is as follows (I've added comments):\r\n\r\n```python\r\n[[5]   # first epoch, first iteration, first batch\r\n [2]]\r\n[[3]      # second batch\r\n [1]]\r\n[[0]      # third batch\r\n [4]]\r\n[[0]   # first epoch, second iteration, first batch\r\n [3]]\r\n[[1]      # second batch\r\n [5]]\r\n[[4]      # third batch\r\n [2]]\r\n[[5]   # second epoch, first iteration, first batch\r\n [2]]\r\n[[3]\r\n [1]]\r\n[[0]\r\n [4]]\r\n[[0]   # second epoch, second iteration, first batch\r\n [3]]\r\n[[1]\r\n [5]]\r\n[[4]\r\n [2]]\r\n```\r\n\r\nAs you can see the order of the data is perfectly identical during the 1st and 2nd epochs. It is only reshuffled at each iteration within the same epoch.\r\n\r\nSo the only way to ensure that the data will be reshuffled at each epoch is to use `dataset.repeat(n_epochs)`, then `model.fit(dataset, steps_per_epoch=..., epochs=n_epochs)`. It feels like unnecessary complexity.",
  "closed_by": {
    "login": "jsimsa",
    "id": 1072079,
    "node_id": "MDQ6VXNlcjEwNzIwNzk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/1072079?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jsimsa",
    "html_url": "https://github.com/jsimsa",
    "followers_url": "https://api.github.com/users/jsimsa/followers",
    "following_url": "https://api.github.com/users/jsimsa/following{/other_user}",
    "gists_url": "https://api.github.com/users/jsimsa/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jsimsa/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jsimsa/subscriptions",
    "organizations_url": "https://api.github.com/users/jsimsa/orgs",
    "repos_url": "https://api.github.com/users/jsimsa/repos",
    "events_url": "https://api.github.com/users/jsimsa/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jsimsa/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/tensorflow/tensorflow/issues/29558/reactions",
    "total_count": 2,
    "+1": 2,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/29558/timeline",
  "performed_via_github_app": null
}

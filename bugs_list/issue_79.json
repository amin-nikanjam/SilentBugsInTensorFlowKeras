{
  "url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30486",
  "repository_url": "https://api.github.com/repos/tensorflow/tensorflow",
  "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30486/labels{/name}",
  "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30486/comments",
  "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30486/events",
  "html_url": "https://github.com/tensorflow/tensorflow/issues/30486",
  "id": 465168426,
  "node_id": "MDU6SXNzdWU0NjUxNjg0MjY=",
  "number": 30486,
  "title": "Keras TimeDistributed on a Model creates duplicate layers, and is inconsistent with TimeDistributed on a Layer",
  "user": {
    "login": "LukeBolly",
    "id": 24449147,
    "node_id": "MDQ6VXNlcjI0NDQ5MTQ3",
    "avatar_url": "https://avatars.githubusercontent.com/u/24449147?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/LukeBolly",
    "html_url": "https://github.com/LukeBolly",
    "followers_url": "https://api.github.com/users/LukeBolly/followers",
    "following_url": "https://api.github.com/users/LukeBolly/following{/other_user}",
    "gists_url": "https://api.github.com/users/LukeBolly/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/LukeBolly/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/LukeBolly/subscriptions",
    "organizations_url": "https://api.github.com/users/LukeBolly/orgs",
    "repos_url": "https://api.github.com/users/LukeBolly/repos",
    "events_url": "https://api.github.com/users/LukeBolly/events{/privacy}",
    "received_events_url": "https://api.github.com/users/LukeBolly/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 473172988,
      "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug",
      "name": "type:bug",
      "color": "159b2e",
      "default": false,
      "description": "Bug"
    },
    {
      "id": 1097546578,
      "node_id": "MDU6TGFiZWwxMDk3NTQ2NTc4",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:keras",
      "name": "comp:keras",
      "color": "0052cc",
      "default": false,
      "description": "Keras related issues"
    },
    {
      "id": 1445545631,
      "node_id": "MDU6TGFiZWwxNDQ1NTQ1NjMx",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/TF%201.14",
      "name": "TF 1.14",
      "color": "5319e7",
      "default": false,
      "description": "for issues seen with TF 1.14"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "omalleyt12",
    "id": 29100818,
    "node_id": "MDQ6VXNlcjI5MTAwODE4",
    "avatar_url": "https://avatars.githubusercontent.com/u/29100818?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/omalleyt12",
    "html_url": "https://github.com/omalleyt12",
    "followers_url": "https://api.github.com/users/omalleyt12/followers",
    "following_url": "https://api.github.com/users/omalleyt12/following{/other_user}",
    "gists_url": "https://api.github.com/users/omalleyt12/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/omalleyt12/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/omalleyt12/subscriptions",
    "organizations_url": "https://api.github.com/users/omalleyt12/orgs",
    "repos_url": "https://api.github.com/users/omalleyt12/repos",
    "events_url": "https://api.github.com/users/omalleyt12/events{/privacy}",
    "received_events_url": "https://api.github.com/users/omalleyt12/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "omalleyt12",
      "id": 29100818,
      "node_id": "MDQ6VXNlcjI5MTAwODE4",
      "avatar_url": "https://avatars.githubusercontent.com/u/29100818?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/omalleyt12",
      "html_url": "https://github.com/omalleyt12",
      "followers_url": "https://api.github.com/users/omalleyt12/followers",
      "following_url": "https://api.github.com/users/omalleyt12/following{/other_user}",
      "gists_url": "https://api.github.com/users/omalleyt12/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/omalleyt12/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/omalleyt12/subscriptions",
      "organizations_url": "https://api.github.com/users/omalleyt12/orgs",
      "repos_url": "https://api.github.com/users/omalleyt12/repos",
      "events_url": "https://api.github.com/users/omalleyt12/events{/privacy}",
      "received_events_url": "https://api.github.com/users/omalleyt12/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 4,
  "created_at": "2019-07-08T10:05:09Z",
  "updated_at": "2020-01-09T23:30:47Z",
  "closed_at": "2020-01-09T23:30:45Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "<em>Please make sure that this is a bug. As per our [GitHub Policy](https://github.com/tensorflow/tensorflow/blob/master/ISSUES.md), we only address code/doc bugs, performance issues, feature requests and build/installation issues on GitHub. tag:bug_template</em>\r\n\r\n**System information**\r\n- Have I written custom code (as opposed to using a stock example script provided in TensorFlow): Yes\r\n- OS Platform and Distribution (e.g., Linux Ubuntu 16.04): Windows 10\r\n- TensorFlow installed from (source or binary): Binary\r\n- TensorFlow version (use command below): tensorflow-gpu 1.14.0\r\n- Python version: 3.6.7\r\n- CUDA/cuDNN version: 10\r\n- GPU model and memory: GTX1060M\r\n\r\n**Describe the current behavior**\r\nWrapping a model in a TimeDistributed layer creates duplicate nodes in the graph. If we follow the docs [(link)](https://keras.io/getting-started/functional-api-guide/#all-models-are-callable-just-like-layers) and create a simple Dense Model wrapped in a TD Layer:\r\n```\r\n    inner_input = keras.layers.Input((2,))\r\n    dense = keras.layers.Dense(2, activation='relu')(inner_input)\r\n    inner_model = keras.Model(inputs=inner_input, outputs=dense)\r\n\r\n    full_input = keras.layers.Input((2,2))\r\n    td_2 = keras.layers.TimeDistributed(inner_model)(full_input)\r\n    model = keras.models.Model(full_input, td_2)\r\n    model.compile('SGD', 'mse')\r\n```\r\nYou end up with this:\r\n![bad_td](https://user-images.githubusercontent.com/24449147/60799985-d4e60c00-a1a6-11e9-84e8-e0b6ddd2a789.png)\r\nFirstly, if you follow the documentation approach you end up with an additional Dense Layer (Bottom Left). This eats up memory, and happens because you build the inner model then rebuild it again when you build the TimeDistributed model. This can be avoided by parameterizing your model [(link)](https://www.tensorflow.org/beta/guide/keras/custom_layers_and_models#building_models), but it can be a very painful workaround if your model is complex. But for demonstrations sake, here's the model as an object:\r\n```\r\n    class InnerModel(keras.Model):\r\n        def __init__(self):\r\n            super(InnerModel, self).__init__()\r\n\r\n            self.dense = keras.layers.Dense(2, activation='relu')\r\n\r\n        def call(self, inputs, training=None, mask=None):\r\n            out = self.dense(inputs)\r\n            return out\r\n\r\n        def compute_output_shape(self, input_shape):\r\n            return (input_shape[0], 2)\r\n\r\n    input = keras.layers.Input((2,2))\r\n    td_model = InnerModel()\r\n    time_dist = keras.layers.TimeDistributed(td_model)(input)\r\n    model = keras.models.Model(input, time_dist)\r\n    model.compile('SGD', 'mse')\r\n```\r\nHere's the improved graph:\r\n![better_td](https://user-images.githubusercontent.com/24449147/60801864-58552c80-a1aa-11e9-9550-24068fffc43c.png)\r\n\r\nSo the additional Dense layer is gone, but there are still two dense layers inside. They have different contents too.\r\n![better_td_internal](https://user-images.githubusercontent.com/24449147/60801763-25ab3400-a1aa-11e9-9721-00482828ed58.png)\r\n\r\n\r\n**Describe the expected behavior**\r\nIf you compare to what you get if you just wrap the Dense layer itself:\r\n```\r\n    full_input = keras.layers.Input((2,2,2))\r\n    td_2 = keras.layers.TimeDistributed(keras.layers.Dense(2, activation='relu'))(full_input)\r\n    model = keras.models.Model(full_input, td_2)\r\n    model.compile('SGD', 'mse')\r\n```\r\n![good_td](https://user-images.githubusercontent.com/24449147/60800184-5c337f80-a1a7-11e9-8dd3-901054a537d9.png)\r\n\r\nI'd expect wrapping a model should result in a very similar looking graph to wrapping a layer\r\n\r\n**Code to reproduce the issue**\r\nFull code for creating the graphs:\r\nhttps://gist.github.com/LukeBolly/0efeca3db275dee97c5f0fbf1f400b5a\r\n",
  "closed_by": {
    "login": "ymodak",
    "id": 42785357,
    "node_id": "MDQ6VXNlcjQyNzg1MzU3",
    "avatar_url": "https://avatars.githubusercontent.com/u/42785357?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/ymodak",
    "html_url": "https://github.com/ymodak",
    "followers_url": "https://api.github.com/users/ymodak/followers",
    "following_url": "https://api.github.com/users/ymodak/following{/other_user}",
    "gists_url": "https://api.github.com/users/ymodak/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/ymodak/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/ymodak/subscriptions",
    "organizations_url": "https://api.github.com/users/ymodak/orgs",
    "repos_url": "https://api.github.com/users/ymodak/repos",
    "events_url": "https://api.github.com/users/ymodak/events{/privacy}",
    "received_events_url": "https://api.github.com/users/ymodak/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30486/reactions",
    "total_count": 0,
    "+1": 0,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/30486/timeline",
  "performed_via_github_app": null
}

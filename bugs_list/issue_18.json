{
  "url": "https://api.github.com/repos/tensorflow/tensorflow/issues/38596",
  "repository_url": "https://api.github.com/repos/tensorflow/tensorflow",
  "labels_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/38596/labels{/name}",
  "comments_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/38596/comments",
  "events_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/38596/events",
  "html_url": "https://github.com/tensorflow/tensorflow/issues/38596",
  "id": 600851306,
  "node_id": "MDU6SXNzdWU2MDA4NTEzMDY=",
  "number": 38596,
  "title": "Keras fails to account for smaller last batch in loss metric calculation",
  "user": {
    "login": "bentyeh",
    "id": 8296169,
    "node_id": "MDQ6VXNlcjgyOTYxNjk=",
    "avatar_url": "https://avatars.githubusercontent.com/u/8296169?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/bentyeh",
    "html_url": "https://github.com/bentyeh",
    "followers_url": "https://api.github.com/users/bentyeh/followers",
    "following_url": "https://api.github.com/users/bentyeh/following{/other_user}",
    "gists_url": "https://api.github.com/users/bentyeh/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/bentyeh/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/bentyeh/subscriptions",
    "organizations_url": "https://api.github.com/users/bentyeh/orgs",
    "repos_url": "https://api.github.com/users/bentyeh/repos",
    "events_url": "https://api.github.com/users/bentyeh/events{/privacy}",
    "received_events_url": "https://api.github.com/users/bentyeh/received_events",
    "type": "User",
    "site_admin": false
  },
  "labels": [
    {
      "id": 404586594,
      "node_id": "MDU6TGFiZWw0MDQ1ODY1OTQ=",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/stat:awaiting%20tensorflower",
      "name": "stat:awaiting tensorflower",
      "color": "f4b400",
      "default": false,
      "description": "Status  - Awaiting response from tensorflower"
    },
    {
      "id": 473172988,
      "node_id": "MDU6TGFiZWw0NzMxNzI5ODg=",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/type:bug",
      "name": "type:bug",
      "color": "159b2e",
      "default": false,
      "description": "Bug"
    },
    {
      "id": 1097546578,
      "node_id": "MDU6TGFiZWwxMDk3NTQ2NTc4",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/comp:keras",
      "name": "comp:keras",
      "color": "0052cc",
      "default": false,
      "description": "Keras related issues"
    },
    {
      "id": 1315098405,
      "node_id": "MDU6TGFiZWwxMzE1MDk4NDA1",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/regression%20issue",
      "name": "regression issue",
      "color": "50bcc4",
      "default": false,
      "description": "To spot regression issues in TF 2.0"
    },
    {
      "id": 1903591931,
      "node_id": "MDU6TGFiZWwxOTAzNTkxOTMx",
      "url": "https://api.github.com/repos/tensorflow/tensorflow/labels/TF%202.2",
      "name": "TF 2.2",
      "color": "0052cc",
      "default": false,
      "description": "Issues related to TF 2.2"
    }
  ],
  "state": "closed",
  "locked": false,
  "assignee": {
    "login": "pavithrasv",
    "id": 13326758,
    "node_id": "MDQ6VXNlcjEzMzI2NzU4",
    "avatar_url": "https://avatars.githubusercontent.com/u/13326758?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/pavithrasv",
    "html_url": "https://github.com/pavithrasv",
    "followers_url": "https://api.github.com/users/pavithrasv/followers",
    "following_url": "https://api.github.com/users/pavithrasv/following{/other_user}",
    "gists_url": "https://api.github.com/users/pavithrasv/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/pavithrasv/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/pavithrasv/subscriptions",
    "organizations_url": "https://api.github.com/users/pavithrasv/orgs",
    "repos_url": "https://api.github.com/users/pavithrasv/repos",
    "events_url": "https://api.github.com/users/pavithrasv/events{/privacy}",
    "received_events_url": "https://api.github.com/users/pavithrasv/received_events",
    "type": "User",
    "site_admin": false
  },
  "assignees": [
    {
      "login": "pavithrasv",
      "id": 13326758,
      "node_id": "MDQ6VXNlcjEzMzI2NzU4",
      "avatar_url": "https://avatars.githubusercontent.com/u/13326758?v=4",
      "gravatar_id": "",
      "url": "https://api.github.com/users/pavithrasv",
      "html_url": "https://github.com/pavithrasv",
      "followers_url": "https://api.github.com/users/pavithrasv/followers",
      "following_url": "https://api.github.com/users/pavithrasv/following{/other_user}",
      "gists_url": "https://api.github.com/users/pavithrasv/gists{/gist_id}",
      "starred_url": "https://api.github.com/users/pavithrasv/starred{/owner}{/repo}",
      "subscriptions_url": "https://api.github.com/users/pavithrasv/subscriptions",
      "organizations_url": "https://api.github.com/users/pavithrasv/orgs",
      "repos_url": "https://api.github.com/users/pavithrasv/repos",
      "events_url": "https://api.github.com/users/pavithrasv/events{/privacy}",
      "received_events_url": "https://api.github.com/users/pavithrasv/received_events",
      "type": "User",
      "site_admin": false
    }
  ],
  "milestone": null,
  "comments": 6,
  "created_at": "2020-04-16T08:34:39Z",
  "updated_at": "2020-04-28T17:43:56Z",
  "closed_at": "2020-04-28T17:39:01Z",
  "author_association": "NONE",
  "active_lock_reason": null,
  "body": "## System information\r\n- OS Platform and Distribution: Google Colab Notebook\r\n- TensorFlow version (use command below): 2.2.0-rc2\r\n- Python version: 3.6\r\n\r\n## Describe the current behavior\r\n\r\nIn `tf.keras` models, the `model.test_step()` method (which is called by `model.fit()` and `model.evaluate()`) incorrectly computes the mean loss over all batches in an epoch when the dataset size is not evenly divisible by the batch size. This applies for both training and validation loss. This bug affects the reported epoch loss, but NOT the training loss used for computing gradient updates.\r\n\r\nCurrently, TensorFlow-Keras computes the loss for each batch, adds together the losses across batches, then divides by the number of batches. In other words, the reported loss at the end of each epoch is (incorrectly) unweighted with respect to the size of each batch.\r\n\r\nFor example, suppose there are 3 samples in a dataset, and the batch size is 2. Then there are 2 batches of size 2 and 1. If the first batch has mean loss of 10 and the second batch has mean loss of 9, then the mean loss over the entire dataset is currently (incorrectly) computed as `(10 + 9) / 2 = 9.5`.\r\n\r\n## Describe the expected behavior\r\n\r\nContinuing with the example above, the correct mean loss over the dataset should be a weighted mean of the batch losses, where the weights are given by each batch size. Thus, the correct mean loss should be `(10*2 + 9*1) / (2 + 1) = 9.66666`. This is shown in the code below.\r\n\r\n## Standalone code to reproduce the issue\r\n\r\nCode ([gist here](https://colab.research.google.com/gist/bentyeh/9ec7fd68564f411cc4a1f8a7060c9b92/tf_keras_issue38596.ipynb))\r\n\r\n```python\r\nimport tensorflow as tf\r\n\r\nX = tf.constant([[1],\r\n                 [2],\r\n                 [3]], dtype=tf.float32)\r\ny = tf.constant([[5],\r\n                 [4],\r\n                 [6]], dtype=tf.float32)\r\n\r\n# y_pred = a * x + b, where weights are intialized as a = 1, b = 0\r\n# thus, MSE = (x - y)**2 / len(x)\r\nmodel = tf.keras.Sequential([\r\n    tf.keras.layers.Dense(1, input_dim=1, kernel_initializer='ones', bias_initializer='zeros')])\r\nmodel.compile(optimizer='sgd', loss='mean_squared_error')\r\n\r\ndef mse(y, y_pred):\r\n    assert len(y) == len(y_pred)\r\n    return sum((y - y_pred)**2)/len(y)\r\n\r\nprint('model.evaluate():')\r\nprint('- batch_size=1:', model.evaluate(X, y, batch_size=1, verbose=0))\r\nprint('- batch_size=2:', model.evaluate(X, y, batch_size=2, verbose=0))\r\nprint('- batch_size=3:', model.evaluate(X, y, batch_size=3, verbose=0))\r\nprint()\r\n\r\n# incorrect mean of two different-sized batches\r\n# Batch 1 is size 2, but Batch 2 is size 1\r\n# So we should compute a weighted mean, but Tensorflow-Keras fails to do so\r\nprint((mse(X[:-1], y[:-1]) + mse(X[-1], y[-1]))/2)\r\n```\r\n\r\nOutput\r\n```\r\nmodel.evaluate():\r\n- batch_size=1: 9.666666984558105\r\n- batch_size=2: 9.5\r\n- batch_size=3: 9.666666984558105\r\n\r\ntf.Tensor([9.5], shape=(1,), dtype=float32)\r\n```\r\n\r\n## Where this error occurs in TensorFlow source code\r\n\r\nThe following line in the `model.test_step()` method calls the `self.compiled_loss` object.\r\n\r\nhttps://github.com/tensorflow/tensorflow/blob/42052dcb8ea0265e9b8b6eafd2ab3dcb4cb1f73c/tensorflow/python/keras/engine/training.py#L971-L972\r\n\r\n`self.compiled_loss` is a `compile_utils.LossesContainer` object whose `__call__()` method seems to be implemented incorrectly. Specifically, the following line is where each batch's total loss is accumulated over an epoch, but the accumulation is done without any record of the batch size.\r\n\r\nhttps://github.com/tensorflow/tensorflow/blob/42052dcb8ea0265e9b8b6eafd2ab3dcb4cb1f73c/tensorflow/python/keras/engine/compile_utils.py#L235\r\n\r\nConsequently, the mean epoch loss is calculated (`m.result()` below)\r\n\r\nhttps://github.com/tensorflow/tensorflow/blob/42052dcb8ea0265e9b8b6eafd2ab3dcb4cb1f73c/tensorflow/python/keras/engine/training.py#L975\r\n\r\nby dividing the total accumulated loss by the number of batches (`self.count`).\r\n\r\nhttps://github.com/tensorflow/tensorflow/blob/a5a8ceea2180665b660862d1efd1de51ea8cb0c2/tensorflow/python/keras/metrics.py#L383\r\n\r\n## Proposed solution\r\n\r\nI don't know what the best way to solve this problem may be, but the accumulation of each batch's loss should clearly track each batch's actual size. One possible solution may be to use the `sample_weight` argument and replace\r\n\r\nhttps://github.com/tensorflow/tensorflow/blob/42052dcb8ea0265e9b8b6eafd2ab3dcb4cb1f73c/tensorflow/python/keras/engine/compile_utils.py#L235\r\n\r\nwith\r\n\r\n`self._loss_metric.update_state(total_loss_metric_value, sample_weight=ACTUAL_BATCH_SIZE)`\r\n\r\n## Related Issues\r\n\r\nTo the best of my knowledge, the problem described above is the root problem for a number of other reported issues: #35585 #35533 #38004 #38165",
  "closed_by": {
    "login": "jvishnuvardhan",
    "id": 46058173,
    "node_id": "MDQ6VXNlcjQ2MDU4MTcz",
    "avatar_url": "https://avatars.githubusercontent.com/u/46058173?v=4",
    "gravatar_id": "",
    "url": "https://api.github.com/users/jvishnuvardhan",
    "html_url": "https://github.com/jvishnuvardhan",
    "followers_url": "https://api.github.com/users/jvishnuvardhan/followers",
    "following_url": "https://api.github.com/users/jvishnuvardhan/following{/other_user}",
    "gists_url": "https://api.github.com/users/jvishnuvardhan/gists{/gist_id}",
    "starred_url": "https://api.github.com/users/jvishnuvardhan/starred{/owner}{/repo}",
    "subscriptions_url": "https://api.github.com/users/jvishnuvardhan/subscriptions",
    "organizations_url": "https://api.github.com/users/jvishnuvardhan/orgs",
    "repos_url": "https://api.github.com/users/jvishnuvardhan/repos",
    "events_url": "https://api.github.com/users/jvishnuvardhan/events{/privacy}",
    "received_events_url": "https://api.github.com/users/jvishnuvardhan/received_events",
    "type": "User",
    "site_admin": false
  },
  "reactions": {
    "url": "https://api.github.com/repos/tensorflow/tensorflow/issues/38596/reactions",
    "total_count": 1,
    "+1": 1,
    "-1": 0,
    "laugh": 0,
    "hooray": 0,
    "confused": 0,
    "heart": 0,
    "rocket": 0,
    "eyes": 0
  },
  "timeline_url": "https://api.github.com/repos/tensorflow/tensorflow/issues/38596/timeline",
  "performed_via_github_app": null
}
